@page
@model BookTicketModel

@section Styles {
  <link rel="stylesheet" href="~/css/book-ticket.css" />
}

@section Scripts {
  <script>
    $(function () {
      // Activate all tooltips
      $('[data-toggle="tooltip"]').tooltip();

      // Available seat tooltip
      $('.seat-available').tooltip({
        delay: {
          show: 100,
          hide: 0,
        },
        title: function () {
          return $(this).data('seat');
        }
      });

      // Quantity input number only
      $('.quantity-input').on('input', function (e) {
        const string = $(this).val().replace(/\D/g, "");

        const value = parseInt(string, 10) || 0;

        $(this).val(value || 0);
      });

      // Quantity input blur on Enter or Esc
      $('.quantity-input').keyup(function (e) {
        if ([13, 27].includes(e.which)) {
          $(this).blur();
        }
      })

      // Update quantity and blur quantity input on minus or plus click
      $('.btn-minus, .btn-plus').click(function (e) {
        const input = $(this).siblings('.quantity-input')

        const newQuantity = $(this).hasClass('btn-minus') ? Math.max(0, input.val() - 1) : +input.val() + 1;

        input.val(newQuantity).blur();
      });

      // Update total price on quantity input blur
      $('.quantity-input').blur(function (e) {
        const tr = $(this).closest('tr');

        const price = parseInt(
          tr.find('.ticket-price')
            .text()
            .replace(/\,/g, ''),
          10);

        tr.find('.total-tickets-price').html(
          (price * $(this).val()).toLocaleString('en-US')
        );
      })

      // Toggle chosen class on available seat click
      $('.seat-available').click(function (e) {
        $(this).toggleClass('seat-chosen seat-available');
      });

      let infoSeats = $('.info-content.info-seats');

      function onAvailableSeatClick() {
        const thisSeat = $(this).data('seat');

        let chosenSeats = infoSeats.text();

        if (chosenSeats.length === 0) {
          chosenSeats = thisSeat
        }
        else {
          chosenSeats += ", " + thisSeat;
        }

        infoSeats.text(chosenSeats);

        $(this).one('click', onChosenSeatClick);
      }

      function onChosenSeatClick() {
        const thisSeat = $(this).data('seat');

        let chosenSeats = infoSeats.text().split(', ');

        chosenSeats = chosenSeats.filter(seat => seat !== thisSeat);

        infoSeats.text(chosenSeats.join(', '));

        $(this).one('click', onAvailableSeatClick);
      }

      $('.seat-available').one('click', onAvailableSeatClick);
    })
  </script>
}

<div class="row">
  <div class="p-0 col-12 col-md-9">
    <div class="card mb-5">
      <h5 class="card-header">
        Choose tickets
      </h5>

      <div class="card-body">
        <table class="table table-striped table-tickets m-0">
          <thead class="thead-dark">
            <tr>
              <th scope="col">Ticket Type</th>
              <th scope="col" class="text-center">Quantity</th>
              <th scope="col" class="text-right">Price (VND)</th>
              <th scope="col" class="text-right">Total (VND)</th>
            </tr>
          </thead>

          <tbody>
            <tr>
              <td>Normal</td>
              <td>
                <div class="d-flex align-items-center justify-content-center">
                  <button class="btn btn-round btn-primary btn-xs btn-minus"><i class="fas fa-minus fa-fw"></i></button>

                  <input class="form-control form-control-sm quantity-input text-center mx-2" value="0" />

                  <button class="btn btn-round btn-primary btn-xs btn-plus"><i class="fas fa-plus fa-fw"></i></button>
                </div>
              </td>
              <td class="text-right ticket-price">75,000</td>
              <td class="text-right total-tickets-price">0</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h5 class="card-header">
        Choose seats
      </h5>

      <div class="card-body">
        <div class="room d-flex flex-column align-items-center">
          <div class="d-flex mb-4">
            <div class="d-flex mr-4 align-items-center">
              <div class="seat seat-available-legend mr-1"></div>
              Available
            </div>

            <div class="d-flex mr-4 align-items-center">
              <div class="seat seat-chosen-legend mr-1"></div>
              Choosing
            </div>

            <div class="d-flex align-items-center">
              <div class="seat seat-sold-legend mr-1"></div>
              Sold
            </div>
          </div>

          <div class="screen pb-1 mb-5 text-center w-50">
            Screen
          </div>

          <div>
            @for (var row = 1; row <= Model.Showtime.Room.NumRow; row++) {
              var rowChar = (char)(row + 64);

              <div class="d-flex mb-2">
                <div class="seat mr-3">
                  @rowChar
                </div>

                @for (var col = 1; col <= Model.Showtime.Room.NumCol; col++) {
                  <div class="seat seat-available has-tooltip mr-1"
                       data-seat="@rowChar&#8209;@col"></div>
                }

                <div class="seat ml-3">
                  @rowChar
                </div>
              </div>
            }

            <div class="d-flex mt-3 justify-content-center">
              @for (var col = 1; col <= Model.Showtime.Room.NumCol; col++) {
                <div class="seat mr-1">
                  @col
                </div>
              }
            </div>
          </div>


        </div>
      </div>
    </div>
  </div>

  <div class="col-12   p-0     mt-5
              col-md-3 pl-md-3 mt-md-0">
    <div class="card sticky-top">
      <h5 class="card-header">Checkout</h5>

      <div class="card-body">
        <div class="d-flex justify-content-center mb-1">
          <img class="info-poster" src="~/uploads/@Model.Showtime.Movie.Img" />
        </div>

        <h6 class="text-center text-uppercase mb-4">Avengers: Endgame</h6>

        <div class="info-line">
          <div class="info-label">
            Theater:
          </div>

          <div class="info-content">
            @Model.Showtime.Theater.Name
          </div>
        </div>

        <div class="info-line">
          <div class="info-label">
            Room:
          </div>

          <div class="info-content">
            @Model.Showtime.Room.Name
          </div>
        </div>

        <div class="info-line">
          <div class="info-label">
            Date:
          </div>

          <div class="info-content">
            @Model.Showtime.Time.ToString("dd/MM/yyyy")
          </div>
        </div>

        <div class="info-line">
          <div class="info-label">
            Time:
          </div>

          <div class="info-content">
            @Model.Showtime.Time.ToString("HH:mm")
          </div>
        </div>

        <div class="info-line">
          <div class="info-label">
            Type:
          </div>

          <div class="info-content">
            @Model.Showtime.FormatString - @Model.Showtime.TypeString
          </div>
        </div>

        <div class="info-line">
          <div class="info-label">
            Seats:
          </div>

          <div class="info-content info-seats"></div>
        </div>
      </div>
    </div>

  </div>
</div>